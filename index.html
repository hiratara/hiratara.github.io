<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>Born in Tomakomai city - Top</title>
        <link rel="stylesheet" type="text/css" href="./css/default.css" />
        <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <!-- Google Analytics tracking codes -->
        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-7637699-4', 'hiratara.github.io');
          ga('send', 'pageview');

        </script>
    </head>
    <body>
        <!-- facebook SDK -->
        <div id="fb-root"></div>
        <script>(function(d, s, id) {
          var js, fjs = d.getElementsByTagName(s)[0];
          if (d.getElementById(id)) return;
          js = d.createElement(s); js.id = id;
          js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=100848266724416";
          fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));</script>

        <div id="header">
            <div id="logo">
                <a href="./">Born in Tomakomai city</a>
            </div>
            <div id="navigation">
                <a href="./">Top</a>
                <a href="./about.html">About</a>
                <a href="./contact.html">Contact</a>
                <a href="./archive.html">Archive</a>
            </div>
        </div>

        <div id="content">
            

<div>
  <h1><a href="./posts/2014-11-20-AdtechScala.html">今日は「アドテク×Scala meetup」の日です</a></h1>

<div class="info">
    Posted on November 20, 2014
    
    <!-- Twitter button -->
    <a href="https://twitter.com/share" class="twitter-share-button" data-url="/posts/2014-11-20-AdtechScala.html" data-text="今日は「アドテク×Scala meetup」の日です" data-via="hiratara">Tweet</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
    <!-- facebook button -->
    <div class="fb-like" data-href="/posts/2014-11-20-AdtechScala.html" data-layout="button_count" data-action="like" data-show-faces="true" data-share="false"></div>
</div>

<p><a href="http://connpass.com/event/8384/">アドテク×Scala meetup</a>へ来ているので、内容を適当にメモっておく。タグは<a href="https://twitter.com/search?q=%23adtech_scala">#adtech_scala</a>とのこと。</p>
<h2 id="挨拶-田村さん">挨拶 / 田村さん</h2>
<ul>
<li>前半はプレゼン、後半はパネルディスカッション</li>
<li>飲み物と寿司あるよ！</li>
<li>スピーカー紹介</li>
</ul>
<h2 id="アドテクを支えるscala---ad-generationの場合野村欣弘さん">「アドテクを支えるScala - Ad Generationの場合」野村欣弘さん</h2>
<ul>
<li>Scalaは1.5年、ネット広告業界は2.5年
<ul>
<li>medibaさんの前もSSP</li>
</ul></li>
<li>なぜScalaを使い始めたか
<ul>
<li>medibaの求人ではScalaについて触れてない。けど使ってる</li>
<li>2011年くらいから Lift を使ってた形跡。それがスタート</li>
<li>Lift押しの人はもう在籍していない・・・</li>
<li>その後Play × Spark</li>
</ul></li>
<li>Ad Generation → スマホに注力したSSP
<ul>
<li>ScaleOutに譲渡予定</li>
<li>ScalaはRTBに使ってる</li>
</ul></li>
<li>流れ
<ul>
<li>SDK → 枠データ参照(RTBかどうか)→RTBサーバ(Scala)→DSP</li>
<li>DSPからのレスは100ms待つ。オークションを実施。高いものをadserverへ返す</li>
<li>戻すものがなければ adnetwork のタグを戻す</li>
<li>ログはfluentd → HDFS → ログ集計(scala)</li>
</ul></li>
<li>rtb-engineはspray (akkaベース。軽量で速い)
<ul>
<li>UIもsprayで実装</li>
<li>70億オークション/月。250(70×3〜4DSP)億bidリクエスト/月</li>
<li>対アドサーバは4,900qps、対DSPは20,000QPS</li>
<li>リソースはまだ余裕ある</li>
</ul></li>
<li>ピーク時にさばけないことがあったので、チューニングした
<ul>
<li>akkaとsprayの設定を見直し。似たような設定項目があって、戸惑う</li>
<li>ベンチをとりながら調整</li>
</ul></li>
<li>コードの見直し
<ul>
<li>ブロックを防ぐためにFutureを利用</li>
<li>スレッドプールを用途ごとに用意 : アドサーバ、DSP、Future、ログ出力、など</li>
</ul></li>
<li>rtb-engine-log
<ul>
<li>sparkを利用。Pythonとかでも書けるけどScalaで</li>
<li>mesos上で実行 : sparkと相性がいいので</li>
<li>7種のログ(オークション関連は4種類)</li>
<li>cronで10分、1時間、1日の粒度</li>
<li>HDFSから読んでPostgressに吐き出し</li>
<li>cron → spark → mesos master → zoo keeper に登録してあるワーカへ</li>
<li>6CPU、20GB を 4台。(master 2、slave 4)</li>
<li>ログの量 500MB〜1.5GB / hour。配信は10台。</li>
<li>12s 〜 40s / job</li>
</ul></li>
<li>spark を使った感想 → 不満はない
<ul>
<li>メモリに乗せると速いけど、乗せすぎるのもよくないという印象</li>
<li>処理が30分で終わるけど、JVMの停止に30分かかるとか</li>
<li>手軽。身構えなくていい。spark-shellがあったり、コレクション操作する感覚だったり</li>
</ul></li>
<li>scalaを使った感想
<ul>
<li>並列、並行処理を使いやすい</li>
<li>アドサーバやRTBサーバには向いている</li>
<li>用途を選ばず使える。JVMなんで。一種類の言語に統一できていい</li>
<li>Javaは知っておいたほうが</li>
<li>チューニングには、JVMのパラメータとか知らないと</li>
</ul></li>
<li>今後の課題
<ul>
<li>チューニングはこのあと誰かがやるよ！</li>
<li>分析などに使えるのを調べたい</li>
</ul></li>
<li>Pのつく言語につかれた方はぜひいらしてください</li>
</ul>
<h2 id="dynalyst-scala-culture韓翔元さん">「Dynalyst Scala {Culture})」韓翔元さん</h2>
<ul>
<li>ノートとかメモっておいたけど消えたのでアドリブで</li>
<li>Javaは8年、Scalaは1年</li>
<li>Dynalyst “Dynamic Retargeting + Analyst”
<ul>
<li>スマホに特化したリターゲティング</li>
<li>Scala 88.7%(前は90%あったんだけど・・・)、Rubyが9.6%</li>
</ul></li>
<li>bid, ad, 計測サーバは spray。その裏にakka。ログはredshiftへ
<ul>
<li>ログの最終形はakka(bidの最適化など)</li>
</ul></li>
<li>sprayの理由
<ul>
<li>ドキュメントが充実</li>
<li>テストキットがいい</li>
<li>ベンチマークも良い</li>
<li>Scalaを使いたかった</li>
</ul></li>
<li>並行性 → 16コアを使い切れてる</li>
<li>ExecutionContext(どのスレッドで実行するか)、Future。for記法使える</li>
<li>spray-routing(他にspray-httpとかもある)
<ul>
<li>DSLっぽく見やすく書ける</li>
<li><code>FutureDirectives</code>。akkaのthreadをブロッキングしない</li>
<li><code>onComplete</code>で実装させて、<code>Success</code>と<code>Failure</code>でパターンマッチ(failureはno bid)</li>
<li><code>Future[A&lt;:BidResponse]</code></li>
</ul></li>
<li>ひとつのFutureにすべての計算を入れるのは良くない</li>
<li>Router, Logic, External Resourcesの3レイヤに分ける
<ul>
<li>スレッドをキックするディスパッチャが必要</li>
<li>3つ一緒でもいいし、レイヤごとでも(dynalystはレイヤごとに最適化)</li>
<li>レイヤのローカルスコープに、 <code>implicit val</code> で定義</li>
</ul></li>
<li>Futureのテスト → 別スレッドなので普通には無理
<ul>
<li>Specs2 を使う <code>Matcher[Future[T]]</code></li>
<li><code>.await</code> できる。リトライやタイムアウトも</li>
</ul></li>
<li>jenkinsを使っているが、CIのサイドエフェクトの影響でテスト落ちることが
<ul>
<li>再ビルド時間かかる。切り分け辛い</li>
<li>Abstract Future → <code>Monad[M]</code> にしておけばおｋ</li>
<li><code>Service</code> のコンパニオンで、<code>M</code>を<code>Future</code>にしたり<code>Id</code>にしたり</li>
<li>テストでは <code>Id</code> 、 本番では <code>Future</code></li>
</ul></li>
<li><code>Monad</code>とは → 構造。ステップごとに評価するもの。</li>
<li>akkaはakka.io読め
<ul>
<li>バッチではなくデーモンで動かしてる</li>
</ul></li>
<li>Master / Workerパターンを使う (letitcrash.comのポスト)
<ul>
<li>Master, Worker, Requester の3つのアクター</li>
<li>WorkerはMasterから仕事を受け取って、Futureで仕事をさせる(自分のスレッドはブロックしない)</li>
</ul></li>
<li>Akkaの監視の仕方
<ul>
<li>Typesafe Console
<ul>
<li>UIはいい。type safe社のサポート</li>
<li>値段が高いのでやめた</li>
</ul></li>
<li>Kamon
<ul>
<li>無料なのでこっち</li>
<li>Akka, Spray, Playをサポート</li>
<li>Mailボックスのたまり具合、スループットなどの監視</li>
<li>StatsD、New Relic, Datadog などで可視化</li>
<li>Migrationはけっこう大変(昨日コンパイルエラー出たのでpull-reqした)</li>
</ul></li>
</ul></li>
<li>Kamonとzabbixを連携
<ul>
<li>StatsDにzabbix統合を利用</li>
<li>ルータはスレッド使わない、DB周りはスレッド多い</li>
</ul></li>
<li>まとめ
<ul>
<li>SprayのFutureDirectiveを使ってる</li>
<li>Abstract Futureでテストしやすく</li>
<li>Akkaはmaster/worker パターンを使ってスケールできる構成</li>
<li>Kamonでモニタリング</li>
</ul></li>
<li>https://github.com/alexandru/scala-best-practices というのがある
<ul>
<li>学習コストが高いと言われることが多いので</li>
<li>“MUST NOT, SHOULD NOT” だらけ → Scala選ばない理由になりそう・・・</li>
<li>このページで勉強するといいんじゃね</li>
<li>トライアンドエラーを繰り返して、いいものを見つけるのがエンジニアのやることでしょう</li>
</ul></li>
</ul>
<h2 id="アドテクscalaパフォーマンスチューニング水谷陽介さん">「アドテク×Scala×パフォーマンスチューニング」水谷陽介さん</h2>
<ul>
<li>DSS Tech Blogってのがあるので見てね</li>
<li>DSPとは → SSPへ入札する</li>
<li>すべてのプロダクトでscalaを採用している
<ul>
<li>サーバサイド、webコンソール、バッチ</li>
</ul></li>
<li>パフォーマンスチューニングの目的
<ul>
<li>システムの課題の解消
<ul>
<li>甲府カジノ問題、レイテンシー、バッチ処理の時間超過、開発ツールの動作の遅さ</li>
</ul></li>
<li>インフラコストの削減
<ul>
<li>アドテクではコストが肥大化しがち</li>
<li>配信料による利益＞インフラ投資 を満たさないと</li>
</ul></li>
<li>パフォーマンスチューニングにもコスト・リスクはある→インフラ増強が一番の場合もあるので注意</li>
</ul></li>
<li>チューニングの仕方→メトリクス測定、ボトルネック特定、仮説を立てて調整</li>
<li>「80%の時間はコードの20%が占める」パレートの法則
<ul>
<li>半分くらいはデータベースが原因</li>
<li>次点は非同期・スレッド。Scalaの問題とか</li>
<li>正しい実装をしていればI/O bindになる</li>
</ul></li>
<li>I/O : メモリ、ディスク、ネットワーク
<ul>
<li>CPU命令を1回1秒とすると、メモリから読み込み3日, ディスク6.5ヶ月, レイテンシ5年</li>
</ul></li>
<li>10kbのファイルを100万個読んだ場合 → シーク2.5h 。1回のシークだと3.5msで済む</li>
<li>メモリ、処理量、応答速度は3すくみの関係
<ul>
<li>比重を変えるのがチューニング</li>
<li>面積を増やすのが最適化</li>
</ul></li>
<li>パフォーマンスチューニングは、性能要件について関係者の合意を得ることから
<ul>
<li>ブラウザ数、配信数の見積り</li>
<li>月間10億impだと、1000QPSくらいでしょう</li>
<li>トラッカーを受け取る量</li>
<li>集計するもの。誰が何を見るのか</li>
<li>ビジネスサイドの制約→年度内売上など</li>
<li>数字を出すのが大事。性能テストの目標とする</li>
</ul></li>
<li>並行プログラミングモデルの設計は重要
<ul>
<li>ブロッキングを減らす。FutureとActorを使うのか</li>
<li>スレッドプールのサイズは本番デプロイしないとわからない</li>
</ul></li>
<li>DB設計 : ルックアップ回数。レコードあたりのサイズとか。メモリ使用量。</li>
<li>最初の実装は簡潔さ、明快さを優先
<ul>
<li>線形より悪いアルゴリズムは避けること</li>
<li>推測するな、計測すべし</li>
<li>sbt-jmh マイクロベンチマークツール。<code>run</code>にオプション指定するだけ</li>
</ul></li>
<li>Scalaコードの最適化
<ul>
<li>コレクションを正しく使う</li>
<li>関数呼び出しより再帰を使うとオーバヘッドを防げる</li>
<li>例: <code>List#length</code> の計算量は <code>O(n)</code> でそれを <code>n</code> 回呼ぶようなコード</li>
<li>ScalaBlitz : Scalaコレクションの高速化 (マクロでごにょごにょ)</li>
</ul></li>
<li>性能テスト
<ul>
<li>シンプルであれば ab</li>
<li>Gatling → Scalaで書かれたテストツール</li>
<li>JMeterの時代は終わった！</li>
<li>負荷をかける側のリソースに注意</li>
<li>二箇所以上変更しない</li>
</ul></li>
<li>ログの記録、異常検知が大事
<ul>
<li>GCログを出す</li>
<li>JMX</li>
<li><code>/dev/null</code> に捨てない</li>
<li>SLF4J + Profiler どこの処理がボトルネックか</li>
<li>可視化 Grafana + Graphite : トレンドを見れる</li>
</ul></li>
<li>それでも行き詰まったら : C++</li>
</ul>
<!--
## 「軽量言語メインのWeb系エンジニアだった自分がScalaのシステム開発に携わることになった経緯」 重村道人さん
-->

</div>



<div>
  <h1><a href="./posts/2014-10-26-conc_haskell_2.html">今日は「第2回 「Haskellによる並列・並行プログラミング」読書会」の日です</a></h1>

<div class="info">
    Posted on October 26, 2014
    
    <!-- Twitter button -->
    <a href="https://twitter.com/share" class="twitter-share-button" data-url="/posts/2014-10-26-conc_haskell_2.html" data-text="今日は「第2回 「Haskellによる並列・並行プログラミング」読書会」の日です" data-via="hiratara">Tweet</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
    <!-- facebook button -->
    <div class="fb-like" data-href="/posts/2014-10-26-conc_haskell_2.html" data-layout="button_count" data-action="like" data-show-faces="true" data-share="false"></div>
</div>

<p><a href="http://partake.in/events/8cb2c3a9-777d-450a-8e1c-350bbb1eb324">第2回 「Haskellによる並列・並行プログラミング」読書会</a>へ来ている。基本的に朗読形式なので、議論を中心にメモしておく。</p>
<ul>
<li>4章 データフロー並列:Parモナド
<ul>
<li>p.59 <code>IVar i</code> より 「<code>IVar</code> の <code>i</code>」と書くべきではないか</li>
<li>p.61 <code>put_</code> で速度が向上するのはなぜか → 評価済かどうか、データ構造を末端までなめなくていいため</li>
<li><code>IVar</code> はなぜ <code>Eq</code> なの？</li>
<li>実装を見ると <code>IORef</code> で実装されてる (via: http://hackage.haskell.org/package/monad-par-0.3.4.6/docs/src/Control-Monad-Par-Scheds-Direct.html#IVar )</li>
</ul></li>
<li>4.1 例:グラフの最短経路
<ul>
<li>グラフの番号は飛び飛びでもいいの？ → 多分連続してい</li>
<li>ノードが連結してないとまずいのでは？ → 大きいウェイトで表せばいいでしょう</li>
<li><code>k=0</code>のとき直接のノードのみになるとは？ → 経由がないので</li>
<li>脱線: <code>Nothing</code> と <code>Just</code> に順序ついてるけど、逆にしたいとこもあるのでは？ → そういう <code>Down</code> 型がある</li>
<li><code>Maybe</code> を使ってるけど、 <code>Maybe</code> と同じ性質を持ってるわけではないよね。ので <code>newtype</code> すべき</li>
<li>Generalized newtype deriving拡張ってのがあるので、それで楽できる</li>
<li>長さとは重みの合計？ → はい。微妙かも</li>
<li><code>Data.IntMap.Strict</code> が新しいバージョンにはある</li>
<li>畳み込みは結合的だと並列化できる？ → 結合則があればどこからでも</li>
<li>なんで3.02倍？→4.17/1.38</li>
</ul></li>
<li>4.2 パイプライン並列
<ul>
<li>p.67 <code>ByteStrings</code> になってる</li>
<li>p.68 <code>sa.hs</code> ではなく <code>rsa.hs</code></li>
<li>試しに rsa-pipeline.hs の threadscope を動かしてみる</li>
<li>生産者が <code>Fork</code> を入れる。消費者が <code>fork</code> する。<a href="http://hiratara.github.io/posts/2014-09-14-parallel-haskel-excersize.html">参考</a></li>
</ul></li>
<li>4.2.1 生産者の流量制限</li>
<li>4.2.2 パイプライン並列の制限</li>
<li>4.3 会議の時間割
<ul>
<li>p.69 「各パイプラインステージが単一のforkによるもので」は読み替える微妙な日本語？</li>
<li>p.72 <code>timetable</code> の定義が途中で切れてる？ → 以降に実装が続いていて、p.74で完成してる</li>
<li>p.74 「永遠に帰ってこない」は「永遠に返って来ない」？</li>
</ul></li>
<li>4.3.1 並列性の追加
<ul>
<li>Pattern guards は Haskell2010 から入ってる</li>
</ul></li>
<li>4.4 例:並列型推論器</li>
<li>4.5 別のスケジューラを使う</li>
<li>4.6 戦略と比較したParモナド</li>
<li>5章 Repaを用いたデータ並列プログラミング
<ul>
<li>p.86 「型 <code>a</code> のリストを要素として受け取り」ちょっとおかしい。elementsは複数形</li>
<li><code>Source</code> 型クラスむずい(type familyとか使ってる)</li>
<li>型クラスについては「深く考えないでください」</li>
<li>ここまで頑張るなら命令形言語使えばいいのでは</li>
<li>INLINEプラグマで展開するステップまで指定している→「注意深く設計されているので」</li>
</ul></li>
</ul>
<p>次回はp.91の5.3より。</p>

</div>



<div>
  <h1><a href="./posts/2014-10-05-fairly_tmvar.html">Haskellによる並列・並行プログラミングの10.9</a></h1>

<div class="info">
    Posted on October  5, 2014
    
    <!-- Twitter button -->
    <a href="https://twitter.com/share" class="twitter-share-button" data-url="/posts/2014-10-05-fairly_tmvar.html" data-text="Haskellによる並列・並行プログラミングの10.9" data-via="hiratara">Tweet</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
    <!-- facebook button -->
    <div class="fb-like" data-href="/posts/2014-10-05-fairly_tmvar.html" data-layout="button_count" data-action="like" data-show-faces="true" data-share="false"></div>
</div>

<p>公平性のある <code>TMVar</code> を実施しなさいというお題の<a href="https://github.com/hiratara/parconc-examples/commit/43f0be6ea3d39f6b277cb599f46cae1539ed0681">回答</a>を書いたので簡単に解説。</p>
<p>例えば <code>putMVar</code> ですでに値が入っているとき、キューに <code>TVar</code> を突っ込んでおいてそのままブロックし、 <code>takeMVar</code> によって値が空になったら起こして欲しい。が、書籍にも書いてあるとおり、 <code>STM</code> モナドではブロックは <code>retry</code> なので、ブロックするとキューに <code>TVar</code> を突っ込んだってこともトランザクションの破棄によって捨てられてしまう。</p>
<p>そこで、<code>STM</code>モナドではキューに突っ込むところまでやり、ブロックする処理は戻り値の <code>IO</code> アクションに任せることにするとうまくいく。以下の部分だ。</p>
<pre><code>putTMVar :: Show a =&gt; TMVar a -&gt; a -&gt; STM.STM (IO ())
...(snip)...
    Just _  -&gt; do
      t' &lt;- STM.newTVar (Just a)
      STM.writeTVar queue (qs ++ [t'])
      return $ do
        STM.atomically $ do
          tvar &lt;- STM.readTVar t'
          case tvar of
           Nothing -&gt; return ()
           Just _ -&gt; STM.retry
        return ()</code></pre>
<p><code>t'</code>をキューに突っ込んだ後は、ブロックするための <code>IO</code> モナドを作っている。この <code>IO</code> 値内で <code>atomically</code> + <code>retry</code> させることでブロックを実現している。</p>
<p>型が変わったせいで、利用側も若干めんどくさくなるが、原則 <code>join</code> で <code>atomically</code> の戻り値を潰すだけで問題ない。</p>
<pre><code>    join . STM.atomically $ putTMVar done 1</code></pre>
<pre><code>  n1 &lt;- join . STM.atomically $ takeTMVar done</code></pre>

</div>



<div>
  <h1><a href="./posts/2014-09-23-let_ghci_load_compiled_codes.html">cabal buildで作った*.oをcabal replで再利用させる</a></h1>

<div class="info">
    Posted on September 23, 2014
    
    <!-- Twitter button -->
    <a href="https://twitter.com/share" class="twitter-share-button" data-url="/posts/2014-09-23-let_ghci_load_compiled_codes.html" data-text="cabal buildで作った*.oをcabal replで再利用させる" data-via="hiratara">Tweet</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
    <!-- facebook button -->
    <div class="fb-like" data-href="/posts/2014-09-23-let_ghci_load_compiled_codes.html" data-layout="button_count" data-action="like" data-show-faces="true" data-share="false"></div>
</div>

<p>最初に断っておくと、開発時にこの方法を使うことは稀だと思う(<a href="https://twitter.com/search?q=%23heyhey_haskell">#heyhey_haskell</a>懇親会調べ)。あくまでも興味本位でやっていることだとを念頭に入れておいてもらいたい。</p>
<p><a href="http://www.haskell.org/ghc/docs/7.8.3/html/users_guide/ghci-compiled.html">ghciのマニュアル</a>に書いてある原理は把握した上で、やりたかったのは<a href="http://stackoverflow.com/questions/15125825/how-to-reuse-cabal-compiled-modules-when-using-ghci">stackoverflowに出ていたこの質問</a>。幸い <code>cabal repl</code>だと、 <code>-odir</code> に適切な値を渡してくれるので、自前でこの質問にあるようなオプションを指定する必要はない。</p>
<p>が、ghc 7.8.3現在では、これだけではうまくいかない。まず、 <code>*.cabal</code> 内に <code>executable</code> として指定されているターゲットについては <a href="http://d.hatena.ne.jp/kazu-yamamoto/20130912/1378955823">kazu-yamamotoさんのエントリ</a> に書いてあるとおり <code>cabal</code> は静的ライブラリしか作らず <code>ghci</code> は動的ライブラリを見に行くのでうまく行かない。これは以下のようにbuildしておくと<code>ghci</code>から<code>*.o</code>を参照するようになる。</p>
<pre><code>cabal build --ghc-option=-dynamic sudoku3</code></pre>
<p>もっとひどいのは <code>library</code> 指定されている方で、 <code>cabal</code> のissueに上げられている <a href="https://github.com/haskell/cabal/issues/2048">この問題</a> が ghc-7.8.3 でも解決していない。これに対するワークアラウンドは以下のようなもの。</p>
<pre><code>cabal repl --ghc-options='-dynamic -osuf dyn_o -hisuf dyn_hi' lib:typedperl</code></pre>
<p>どうしてこれで <code>cabal</code> が差し込んでいる <code>-dynamic-too</code> が悪さしなくなるのか理解しがたい部分もあるが、こちらの環境ではこれで望みどおりの挙動(コンパイル済コードについてはコンパイルが走らない)となった。いずれにせよ、<a href="https://ghc.haskell.org/trac/ghc/ticket/8736">ghc 7.8.4では直して欲しい問題</a>である。</p>

</div>



<div>
  <h1><a href="./posts/2014-09-21-conc_haskell_1.html">今日は「第1回 「Haskellによる並列・並行プログラミング」読書会」の日です</a></h1>

<div class="info">
    Posted on September 21, 2014
    
    <!-- Twitter button -->
    <a href="https://twitter.com/share" class="twitter-share-button" data-url="/posts/2014-09-21-conc_haskell_1.html" data-text="今日は「第1回 「Haskellによる並列・並行プログラミング」読書会」の日です" data-via="hiratara">Tweet</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
    <!-- facebook button -->
    <div class="fb-like" data-href="/posts/2014-09-21-conc_haskell_1.html" data-layout="button_count" data-action="like" data-show-faces="true" data-share="false"></div>
</div>

<p><a href="http://partake.in/events/b3f4f0f2-8c0a-47c9-b253-b6bd691a45f0">第1回 「Haskellによる並列・並行プログラミング」読書会</a>へ来ている。基本的に朗読形式なので、議論を中心にメモしておく。</p>
<ul>
<li>訳者まえがき
<ul>
<li>「放牧的」より「牧歌的」では</li>
</ul></li>
<li>まえがき
<ul>
<li>p.viii 「4、5、6、14章」の後に変な改行が入ってる</li>
<li>p.viii s/13章はまずII部/13章はまずI部/</li>
</ul></li>
<li>1章 はじめに</li>
<li>1.1 用語：並列性と並行性</li>
<li>1.2 ツールとリソース</li>
<li>1.3 サンプルコード
<ul>
<li>p.4 プロンプトが一個だけ<code>%</code>になってる</li>
</ul></li>
<li>I部 並列Haskell
<ul>
<li>「広範囲の並列ハードウェア」？ 「いろんな並列ハードウェア」？</li>
<li>GCとは→踏み込むと危険なのでスルー</li>
<li>p. 6 s/データフロー並列/4章 データフロー並列/</li>
<li>不安定とは？ →性能が不安定という意味</li>
</ul></li>
<li>2章 基本の並列性:Evalモナド</li>
<li>2.1 遅延評価と弱頭部正規形
<ul>
<li>p.10の|はなに？ → (box化された)Integerの意</li>
<li>:sprintのsは？ simplified</li>
<li>p.9 の例とかで <code>:: Int</code> がないと <code>x</code> が <code>_</code> になるんだけど？ → ghcの7.8系から</li>
<li>p.12 <code>z = _</code> になるんじゃないの？ → データコンストラクタは遅延されない</li>
</ul></li>
<li>2.2 Evalモナド、rpar、rseq
<ul>
<li><code>data Eval a</code> って右辺要らないの？ → 型定義のみ書いてるだけ</li>
<li>「プログラムの残りは実行」とは？ → <code>f x</code>と<code>f y</code>も並列に走るという意味</li>
<li>p.18 s/<code>RTS -N2</code>/<code>+RTS -N2</code>/</li>
</ul></li>
<li>2.3 例：並列数独ソルバ
<ul>
<li>p.21 s/2つのが出力/2つが出力/</li>
</ul></li>
<li>2.4 Deepseq
<ul>
<li><code>!</code> と <code>seq</code>の違いは？ → シンタクスシュガー</li>
<li><code>NFData</code>って自動で<code>deriving</code>できないの？ → すべての型クラスは自動導出できるはず。<code>deepseq-generics</code>がある</li>
<li><code>deepseq</code>は自分で実装することはないでしょう</li>
<li>関数は正規形なのか → lambdaのbody部で簡約されているものがあるとまずい　</li>
<li><code>deepseq</code>がO(n)って何？→評価は終わってるけど、データ構造は辿らないとダメなので</li>
</ul></li>
<li>3章 評価戦略
<ul>
<li><code>Strategy</code>は型だけでなく値も保つことに注意</li>
<li>「1つの<code>Strategy</code>に梱包？」 → “we’ve packaged it up as a Strategy”</li>
</ul></li>
<li>3.1 戦略の並列化</li>
<li>3.2 リストを並列に評価する戦略</li>
<li>3.3 例：K平均法
<ul>
<li>サンプル動かすなら、<code>cabal sandbox init</code> <code>cabal install --only-dependencies</code> <code>cabal build</code>がいい</li>
</ul></li>
<li>3.3.1 K平均法の並列化　</li>
<li>3.3.2 性能と分析
<ul>
<li>少なくとも <code>-Nn</code> の指定した <code>n</code> のOSスレッドは走ってる(実際にはもっと多い)</li>
<li>writeが並列だと影響しない？ → ハンドルに書くにはロックが必要なので影響する</li>
<li><code>MVar</code>でとりあってるはず</li>
<li>ログを吐くようなスレッドを作ればよい → 本の終盤では<code>IORef</code>を使うことになる</li>
</ul></li>
<li>3.3.3 スパーク活動の可視化</li>
<li>3.3.3 粒度</li>
<li>3.4 GCされるスパークと投機的並列性
<ul>
<li><code>strat</code>を指しているものがあるかが重要</li>
<li><code>rpar</code>を悪い使い方してくれてると警告してくれる？ → くれない</li>
<li><code>using</code>を使えば確実？ → <code>using</code>対象は値だから、使われるはず</li>
</ul></li>
<li>3.5 parBufferを使った遅延ストリームの並列化</li>
<li>3.6 チャンク分け戦略</li>
<li>3.7 同一性特性
<ul>
<li>スパークプールのサイズはオプションで変えられる (デフォルト:4096)</li>
<li>あふれると、並列にならない</li>
</ul></li>
</ul>

</div>



<p>…or you can find more in the <a href="./archive.html">archives</a>.

        </div>
        <div id="footer">
            Site proudly generated by
            <a href="http://jaspervdj.be/hakyll">Hakyll</a>
        </div>
    </body>
</html>
