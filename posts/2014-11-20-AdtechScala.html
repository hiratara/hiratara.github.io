<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>Born in Tomakomai city - 今日は「アドテク×Scala meetup」の日です</title>
        <link rel="stylesheet" type="text/css" href="../css/default.css" />
        
        <!-- Google Analytics tracking codes -->
        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-7637699-4', 'hiratara.github.io');
          ga('send', 'pageview');

        </script>
    </head>
    <body>
        <!-- facebook SDK -->
        <div id="fb-root"></div>
        <script>(function(d, s, id) {
          var js, fjs = d.getElementsByTagName(s)[0];
          if (d.getElementById(id)) return;
          js = d.createElement(s); js.id = id;
          js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=100848266724416";
          fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));</script>

        <div id="header">
            <div id="logo">
                <a href="../">Born in Tomakomai city</a>
            </div>
            <div id="navigation">
                <a href="../">Top</a>
                <a href="../about.html">About</a>
                <a href="../contact.html">Contact</a>
                <a href="../archive.html">Archive</a>
            </div>
        </div>

        <div id="content">
            <h1><a href="../posts/2014-11-20-AdtechScala.html">今日は「アドテク×Scala meetup」の日です</a></h1>

<div class="info">
    Posted on November 20, 2014
    
    <!-- Twitter button -->
    <a href="https://twitter.com/share" class="twitter-share-button" data-url="/posts/2014-11-20-AdtechScala.html" data-text="今日は「アドテク×Scala meetup」の日です" data-via="hiratara">Tweet</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
    <!-- facebook button -->
    <div class="fb-like" data-href="/posts/2014-11-20-AdtechScala.html" data-layout="button_count" data-action="like" data-show-faces="true" data-share="false"></div>
</div>

<p><a href="http://connpass.com/event/8384/">アドテク×Scala meetup</a>へ来ているので、内容を適当にメモっておく。タグは<a href="https://twitter.com/search?q=%23adtech_scala">#adtech_scala</a>とのこと。</p>
<h2 id="挨拶-田村さん">挨拶 / 田村さん</h2>
<ul>
<li>前半はプレゼン、後半はパネルディスカッション</li>
<li>飲み物と寿司あるよ！</li>
<li>スピーカー紹介</li>
</ul>
<h2 id="アドテクを支えるscala---ad-generationの場合野村欣弘さん">「アドテクを支えるScala - Ad Generationの場合」野村欣弘さん</h2>
<ul>
<li>Scalaは1.5年、ネット広告業界は2.5年
<ul>
<li>medibaさんの前もSSP</li>
</ul></li>
<li>なぜScalaを使い始めたか
<ul>
<li>medibaの求人ではScalaについて触れてない。けど使ってる</li>
<li>2011年くらいから Lift を使ってた形跡。それがスタート</li>
<li>Lift押しの人はもう在籍していない・・・</li>
<li>その後Play × Spark</li>
</ul></li>
<li>Ad Generation → スマホに注力したSSP
<ul>
<li>ScaleOutに譲渡予定</li>
<li>ScalaはRTBに使ってる</li>
</ul></li>
<li>流れ
<ul>
<li>SDK → 枠データ参照(RTBかどうか)→RTBサーバ(Scala)→DSP</li>
<li>DSPからのレスは100ms待つ。オークションを実施。高いものをadserverへ返す</li>
<li>戻すものがなければ adnetwork のタグを戻す</li>
<li>ログはfluentd → HDFS → ログ集計(scala)</li>
</ul></li>
<li>rtb-engineはspray (akkaベース。軽量で速い)
<ul>
<li>UIもsprayで実装</li>
<li>70億オークション/月。250(70×3〜4DSP)億bidリクエスト/月</li>
<li>対アドサーバは4,900qps、対DSPは20,000QPS</li>
<li>リソースはまだ余裕ある</li>
</ul></li>
<li>ピーク時にさばけないことがあったので、チューニングした
<ul>
<li>akkaとsprayの設定を見直し。似たような設定項目があって、戸惑う</li>
<li>ベンチをとりながら調整</li>
</ul></li>
<li>コードの見直し
<ul>
<li>ブロックを防ぐためにFutureを利用</li>
<li>スレッドプールを用途ごとに用意 : アドサーバ、DSP、Future、ログ出力、など</li>
</ul></li>
<li>rtb-engine-log
<ul>
<li>sparkを利用。Pythonとかでも書けるけどScalaで</li>
<li>mesos上で実行 : sparkと相性がいいので</li>
<li>7種のログ(オークション関連は4種類)</li>
<li>cronで10分、1時間、1日の粒度</li>
<li>HDFSから読んでPostgressに吐き出し</li>
<li>cron → spark → mesos master → zoo keeper に登録してあるワーカへ</li>
<li>6CPU、20GB を 4台。(master 2、slave 4)</li>
<li>ログの量 500MB〜1.5GB / hour。配信は10台。</li>
<li>12s 〜 40s / job</li>
</ul></li>
<li>spark を使った感想 → 不満はない
<ul>
<li>メモリに乗せると速いけど、乗せすぎるのもよくないという印象</li>
<li>処理が30分で終わるけど、JVMの停止に30分かかるとか</li>
<li>手軽。身構えなくていい。spark-shellがあったり、コレクション操作する感覚だったり</li>
</ul></li>
<li>scalaを使った感想
<ul>
<li>並列、並行処理を使いやすい</li>
<li>アドサーバやRTBサーバには向いている</li>
<li>用途を選ばず使える。JVMなんで。一種類の言語に統一できていい</li>
<li>Javaは知っておいたほうが</li>
<li>チューニングには、JVMのパラメータとか知らないと</li>
</ul></li>
<li>今後の課題
<ul>
<li>チューニングはこのあと誰かがやるよ！</li>
<li>分析などに使えるのを調べたい</li>
</ul></li>
<li>Pのつく言語につかれた方はぜひいらしてください</li>
</ul>
<h2 id="dynalyst-scala-culture韓翔元さん">「Dynalyst Scala {Culture})」韓翔元さん</h2>
<ul>
<li>ノートとかメモっておいたけど消えたのでアドリブで</li>
<li>Javaは8年、Scalaは1年</li>
<li>Dynalyst “Dynamic Retargeting + Analyst”
<ul>
<li>スマホに特化したリターゲティング</li>
<li>Scala 88.7%(前は90%あったんだけど・・・)、Rubyが9.6%</li>
</ul></li>
<li>bid, ad, 計測サーバは spray。その裏にakka。ログはredshiftへ
<ul>
<li>ログの最終形はakka(bidの最適化など)</li>
</ul></li>
<li>sprayの理由
<ul>
<li>ドキュメントが充実</li>
<li>テストキットがいい</li>
<li>ベンチマークも良い</li>
<li>Scalaを使いたかった</li>
</ul></li>
<li>並行性 → 16コアを使い切れてる</li>
<li>ExecutionContext(どのスレッドで実行するか)、Future。for記法使える</li>
<li>spray-routing(他にspray-httpとかもある)
<ul>
<li>DSLっぽく見やすく書ける</li>
<li><code>FutureDirectives</code>。akkaのthreadをブロッキングしない</li>
<li><code>onComplete</code>で実装させて、<code>Success</code>と<code>Failure</code>でパターンマッチ(failureはno bid)</li>
<li><code>Future[A&lt;:BidResponse]</code></li>
</ul></li>
<li>ひとつのFutureにすべての計算を入れるのは良くない</li>
<li>Router, Logic, External Resourcesの3レイヤに分ける
<ul>
<li>スレッドをキックするディスパッチャが必要</li>
<li>3つ一緒でもいいし、レイヤごとでも(dynalystはレイヤごとに最適化)</li>
<li>レイヤのローカルスコープに、 <code>implicit val</code> で定義</li>
</ul></li>
<li>Futureのテスト → 別スレッドなので普通には無理
<ul>
<li>Specs2 を使う <code>Matcher[Future[T]]</code></li>
<li><code>.await</code> できる。リトライやタイムアウトも</li>
</ul></li>
<li>jenkinsを使っているが、CIのサイドエフェクトの影響でテスト落ちることが
<ul>
<li>再ビルド時間かかる。切り分け辛い</li>
<li>Abstract Future → <code>Monad[M]</code> にしておけばおｋ</li>
<li><code>Service</code> のコンパニオンで、<code>M</code>を<code>Future</code>にしたり<code>Id</code>にしたり</li>
<li>テストでは <code>Id</code> 、 本番では <code>Future</code></li>
</ul></li>
<li><code>Monad</code>とは → 構造。ステップごとに評価するもの。</li>
<li>akkaはakka.io読め
<ul>
<li>バッチではなくデーモンで動かしてる</li>
</ul></li>
<li>Master / Workerパターンを使う (letitcrash.comのポスト)
<ul>
<li>Master, Worker, Requester の3つのアクター</li>
<li>WorkerはMasterから仕事を受け取って、Futureで仕事をさせる(自分のスレッドはブロックしない)</li>
</ul></li>
<li>Akkaの監視の仕方
<ul>
<li>Typesafe Console
<ul>
<li>UIはいい。type safe社のサポート</li>
<li>値段が高いのでやめた</li>
</ul></li>
<li>Kamon
<ul>
<li>無料なのでこっち</li>
<li>Akka, Spray, Playをサポート</li>
<li>Mailボックスのたまり具合、スループットなどの監視</li>
<li>StatsD、New Relic, Datadog などで可視化</li>
<li>Migrationはけっこう大変(昨日コンパイルエラー出たのでpull-reqした)</li>
</ul></li>
</ul></li>
<li>Kamonとzabbixを連携
<ul>
<li>StatsDにzabbix統合を利用</li>
<li>ルータはスレッド使わない、DB周りはスレッド多い</li>
</ul></li>
<li>まとめ
<ul>
<li>SprayのFutureDirectiveを使ってる</li>
<li>Abstract Futureでテストしやすく</li>
<li>Akkaはmaster/worker パターンを使ってスケールできる構成</li>
<li>Kamonでモニタリング</li>
</ul></li>
<li>https://github.com/alexandru/scala-best-practices というのがある
<ul>
<li>学習コストが高いと言われることが多いので</li>
<li>“MUST NOT, SHOULD NOT” だらけ → Scala選ばない理由になりそう・・・</li>
<li>このページで勉強するといいんじゃね</li>
<li>トライアンドエラーを繰り返して、いいものを見つけるのがエンジニアのやることでしょう</li>
</ul></li>
</ul>
<!--
## 「アドテク×Scala×パフォーマンスチューニング」水谷陽介さん

## 「軽量言語メインのWeb系エンジニアだった自分がScalaのシステム開発に携わることになった経緯」 重村道人さん
-->

        </div>
        <div id="footer">
            Site proudly generated by
            <a href="http://jaspervdj.be/hakyll">Hakyll</a>
        </div>
    </body>
</html>
